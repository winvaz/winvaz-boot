lucene

什么是全文检索
对于搜索，按被搜索的资源类型，分为两种：可以转为文本的、多媒体类型。
全文检索（Full-Text Retrieval）是指以文本作为检索对象，找出含有指定词汇的文本。全面、准确和快速是衡量全文检索系统的关键指标。
关于全文检索，我们要知道：1，只处理文本。2，不处理语义。3，搜索时英文不区分大小写。4，结果列表有相关度排序。
在信息检索工具中，全文检索是最具通用性和实用性的。

--------------------------------------
全文检索的工作流程
如果信息检索系统在用户发出了检索请求后再去互联网上找答案，根本无法在有限的时间内返回结果。
所以要先把要检索的资源集合放到本地，并使用某种特定的结构存储，称为索引，这个索引的集合称为索引库。
由于索引库的结构是按照专门为快速查询设计的，所以查询的速度非常快。我们每次搜索都是在本地的索引库中进行

搜索页面(搜索) --->
                    Lucene
                        索引库  <---建立索引  爬虫  <--->互联网
结果页面   <---搜索

从图片上可以看出，我们不仅要搜索，还要保证数据集合与索引库的一致性。所以对于全文检索功能的开发，
要做的有两个方面：索引库管理（维护索引库中的数据）、在索引库中进行搜索。而Lucene就是操作索引库的工具。

======================================================
使用Lucene的API操作索引库

索引管理            
IndexWriter        Lucene API
    add()              索引库       从索引库中搜索
    delete()                       IndexSearcher
    update()                            ..search()...
    .....

Lucene的数据，Document, Field

索引库是一个目录，里面是一些二进制文件，就如同数据库，所有的数据也是以文件的形式存在文件系统中的。我们不能直接操作这些二进制文件，而是使用Lucene提供的API完成相应的操作，就像操作数据库应使用SQL语句一样。
对索引库的操作可以分为两种：管理与查询。管理索引库使用IndexWriter，从索引库中查询使用IndexSearcher。Lucene的数据结构为Document与Field。Document代表一条数据，Field代表数据中的一个属性。一个Document中有多个Field，Field的值为String型，因为Lucene只处理文本。
我们只需要把在我们的程序中的对象转成Document，就可以交给Lucene管理了，搜索的结果中的数据列表也是Document的集合。

==============================================
索引库结构——倒排序索引
我们需要对文档进行预处理，建立一种便于检索的数据结构，以此来提高信息检索的速度，这种数据结构就是索引。
目前广泛使用的一种索引方式是倒排序索引。
倒排序索引的原理就如同查字典。要先查目录，得到数据对应的页码，在直接翻到指定的页码。不是在文章中找词，而是从目录中找词所在的文章。
这需要在索引库中生成一个词汇表（目录），在词汇表中的每一个条记录都是类似于“词->所在文档的编号列表”的结构，
记录了每一个出现过的单词，和单词出现的地方（哪些文档）。查询时先查词汇表，得到文档的编号，再直接取出相应的文档。

索引库
    文档数据                    词汇表
        中国的首      ----->        中国  第23页
        都是哪里                    首都  第23页
                                   哪里  第23页

把数据转成指定格式放到索引库中的操作叫做建立索引。
建立索引时，在把数据存到索引库后，再更新词汇表。进行搜索时，先从检索词汇表开始，
然后找到相对应的文档。如果查询中仅包含一个关键词，则在词汇表中找到该单词，并取出他对应的文档就可以了。
如果查询中包含多个关键词，则需要将各个单词检索出的记录进行合并再取出相应的文档记录。
如果词汇表中有一个词“百度”对应的文档编号列表为“1”。现在又有添加了一个包含“百度”的文档，
则词汇表中的“百度”词后对应的编号列表变成了“1,2”。因为关键词的数量受实际语言的限制，所以不用担心词汇表会变的很大。

==================================
索引文件的检索与维护，更新是先删除后创建

维护倒排索引有三个操作：添加、删除和更新文档。但是更新操作需要较高的代价。
因为文档修改后（即使是很小的修改），就可能会造成文档中的很多的关键词的位置都发生了变化，这就需要频繁的读取和修改记录，这种代价是相当高的。
因此，一般不进行真正的更新操作，而是使用“先删除，再创建”的方式代替更新操作。

=============================
建立索引的执行过程（Store、Index）

在建立索引时，先要把文档存到索引库中，还要更新词汇表。如下图：
                
                  我们要做的操作            Lucene API  索引库                                    
                                                                                                词汇表
新文档------->Document----------------->   Lucene API  --------->  文档          --------------> 百 1，2
       转成            IndexWriter.                     保存文档    说明：             更新词汇表   度 2，3         
     Document         addDocument(doc)                            每个保存的文档都有              说明：词后面是对应的文档
                                                                  一个唯一的内部编号                   的内部编号的列表
1.	我们做的操作：把数据对象转成相应的Document，其中的属性转为Field。
2.	我们做的操作：调用工具IndexWriter的addDocument(doc)，把Document添加到索引库中。
3.	Lucene做的操作：把文档存到索引库中，并自动指定一个内部编号，用来唯一标识这条数据。
    内部编号类似于这条数据的地址，在索引库内部的数据进行调整后，这个编号就可能会改变，同时词汇表中引用的编号也会做相应改变，以保证正确。
    但我们如果在外面引用了这个编号，前后两次去取，得到的可能不是同一个文档！所以内部编号最好只在内部用。
4.	Lucene做的操作：更新词汇表。把文本中的词找出并放到词汇表中，建立与文档的对应关系。要把哪些词放到词汇表中呢，
    也就是文本中包含哪些词呢？这就用到了一个叫做Analyzer（分词器）的工具。他的作用是把一段文本中的词按规则取出所包含的所有词。
    对应的是Analyzer类，这是一个抽象类，切分词的具体规则是由子类实现的，所以对于不同的语言（规则），要用不同的分词器。
                    Analyzer
    一段文本  ------>   按规则切分  ------->  其中出现的所有的词

说明：Store是影响搜索出的结果中是否有指定属性的原始内容。Index是影响是否可以从这个属性中查询（No），
    或是查询时可以查其中的某些词（ANALYZED），还是要把整个内容作为一个词进行查询（NOT_ANALYZED）。

==============================================
从索引库中搜索的执行过程（QueryParser、TopDocs、ScoreDoc）

在进行搜索时，先在词汇表中查找，得到符合条件的文档编号列表。再根据文档编号真正的去取出数据（Document）。如下图：

                我们要做的操作                      Lucene API      索引库
1  查询字符串  ---------->Query  ------------->                    --------> 词汇表
   (查询条件) 转成Query对象       IndexSearcher.                     查询      百 1，2
                                search(query)                        --     度 2，3
----------------------------------------------                    --
2  查询结果                     <------------      Lucene API    <--
   说明:只有结果信息
   与文档的内部编号集合           ------------>                      -------->
                               indexSearcher.                               文档集合
                               doc(内部编号)                       <--------
---------------------------------------------
3                                            ---
                                          ---
                            Document  <----
                            结果
----------------
1，	把要查询字符串转为Query对象。这就像在Hibernate中使用HQL查询时，也要先调用Session.createQuery(hql)转成Hibernate的Query对象一样。
    把查询字符串转换成Query是使用QueryParser，或使用MultiFieldQueryParser。查询字符串也要先经过Analyzer（分词器）。
    要求搜索时使用的Analyzer要与建立索引时使用的Analzyer要一致，否则可能搜不出正确的结果。
2，	调用IndexSearcher.search()，进行查询，得到结果。此方法返回值为TopDocs，是包含结果的多个信息的一个对象。
    其中有totalHits 代表决记录数，ScoreDoc的数组。ScoreDoc是代表一个结果的相关度得分与文档编号等信息的对象。
3，	取出要用到的数据列表。调用IndexSearcher.doc(scoreDoc.doc)以取出指定编号对应的Document数据。
    在分页时要用到：一次只取一页的数据。

====================================================
HelloWorld
1，	准备场景
2，	添加Lucene环境
3，	完成功能
a)	建立索引
b)	从索引库中搜索

要加入的jar包有：
core\lucene-core-4.7.0.jar（核心包）
analyzers\common\lucene-analyzers-4.7.0.jar（分词器）
highlighter\lucene-highlighter-4.7.0.jar（高亮）
memory\lucene-memory-4.7.0.jar（高亮）
























































